<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>6.8 Safe Pandas - Coding for Data - 2019 edition</title>
<meta name="description" content="A lot of Pandas’ design is for speed and efficiency.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_UK">
<meta property="og:site_name" content="Coding for Data - 2019 edition">
<meta property="og:title" content="6.8 Safe Pandas">
<meta property="og:url" content="https://matthew-brett.github.io/cfd2019/chapters/07/safe_pandas">


  <meta property="og:description" content="A lot of Pandas’ design is for speed and efficiency.">







  <meta property="article:published_time" content="2020-04-07T09:53:41+01:00">





  

  


<link rel="canonical" href="https://matthew-brett.github.io/cfd2019/chapters/07/safe_pandas">







  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "Matthew Brett",
      "url": "https://matthew-brett.github.io/cfd2019",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/cfd2019/feed.xml" type="application/atom+xml" rel="alternate" title="Coding for Data - 2019 edition Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/cfd2019/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->


<!-- end custom head snippets -->

    <link rel="stylesheet" href="/cfd2019/assets/css/notebook-markdown.css">
    <link rel="stylesheet" href="/cfd2019/assets/css/custom.css">
    <link rel="shortcut icon" type="image/png" href="/cfd2019/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/clipboard@1/dist/clipboard.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.1/anchor.min.js"></script>
  </head>

  <body class="layout--textbook">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

    <div class="initial-content">
      



<div id="main" class="textbook" role="main">
  <div id="textbook_wrapper">
    
  <div class="sidebar sticky textbook">
  
  
    <img src="/cfd2019/images/dsfe_logo.png" class="textbook_logo" />
    

    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle Menu</label>
  <ul class="nav__items">
    
      <li>
        
          
          

          <a href="/cfd2019/"><span class="nav__sub-title">Home</span></a>
        

        
      </li>
    
      <li>
        
          
          

          <a href="/cfd2019/chapters/01/intro"><span class="nav__sub-title">1. Coding for data</span></a>
        

        
        <ul>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/01/what-is-data-science" class="level_1">1.1 What is data science?</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/01/why-data-science" class="level_1">1.2 Why data science?</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/01/tools_techniques" class="level_1">1.3 Tools and techniques</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/01/computational-tools" class="level_2">1.3.1 Computational tools</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/01/statistical-techniques" class="level_2">1.3.2 Statistical techniques</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/01/Plotting_the_Classics" class="level_1">1.4 Plotting the classics</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/01/Literary_Characters" class="level_2">1.4.1 Literary characters</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/01/Another_Kind_Of_Character" class="level_2">1.4.2 Another kind of character</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/01/surviving_computers" class="level_1">1.5 Surviving the computer</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/01/the_software" class="level_1">1.6 About the software</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/01/using_jupyter" class="level_1">1.7 Using the Jupyter notebook</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/01/more_on_jupyter" class="level_1">1.8 More on the Jupyter notebook</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          
          

          <a href="/cfd2019/chapters/02/to_code"><span class="nav__sub-title">2. Programming</span></a>
        

        
        <ul>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/02/sampling_problem" class="level_1">2.1 A sampling problem</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/02/three_girls" class="level_1">2.2 A simpler problem</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/02/variables_intro" class="level_1">2.3 Introduction to variables</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/02/functions" class="level_1">2.4 Introduction to functions</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/02/first_pass_three_girls" class="level_1">2.5 A first pass</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/02/Expressions" class="level_1">2.6 Expressions</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/02/Calls" class="level_1">2.7 Call expressions</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/02/sub_expressions" class="level_1">2.8 Sub-expressions</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/02/Names" class="level_1">2.9 Names and variables</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          
          

          <a href="/cfd2019/chapters/03/data_types"><span class="nav__sub-title">3. Data types</span></a>
        

        
        <ul>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/03/Numbers" class="level_1">3.1 Numbers</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/03/Strings" class="level_1">3.2 Strings</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/03/String_Methods" class="level_2">3.2.1 String methods</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/03/Comparison" class="level_1">3.3 Comparison</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/03/lists" class="level_1">3.4 Lists</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/03/Arrays" class="level_1">3.5 Arrays</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/03/Ranges" class="level_1">3.6 Ranges</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/03/numpy_append" class="level_1">3.7 Append</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/03/function_arguments" class="level_1">3.8 Function arguments</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/03/leaping_ahead" class="level_1">3.9 Leaping ahead</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/03/iteration" class="level_1">3.10 Iteration with For loops</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/03/indentation" class="level_1">3.11 Indentation, indentation</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/03/reply_supreme" class="level_1">3.12 Reply to the Supreme Court</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/03/More_on_Arrays" class="level_1">3.13 More on arrays</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/03/array_indexing" class="level_1">3.14 Selecting in arrays</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/03/filling_arrays" class="level_1">3.15 Filling arrays</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          
          

          <a href="/cfd2019/chapters/04/data_frames"><span class="nav__sub-title">4. Data frames</span></a>
        

        
        <ul>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/04/data_frame_intro" class="level_1">4.1 Introduction to data frames</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/04/df_series_arrays" class="level_1">4.2 Data frames, Series and arrays</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          
          

          <a href="/cfd2019/chapters/05/permutation"><span class="nav__sub-title">5. Permutations</span></a>
        

        
        <ul>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/05/population_permutation" class="level_1">5.1 Population and permutation</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/05/brexit_ages" class="level_1">5.2 A permutation test</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/05/permutation_idea" class="level_1">5.3 The permutation idea</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/05/permutation_and_t_test" class="level_1">5.4 Permutation and the t-test</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/05/testing_t" class="level_1">5.5 Testing validity of tests</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          
          

          <a href="/cfd2019/chapters/07/more_building_blocks"><span class="nav__sub-title">6. More building blocks</span></a>
        

        
        <ul>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/07/introducing_functions" class="level_1">6.1 Introduction to functions</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/07/none" class="level_1">6.2 On None</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/07/functions" class="level_1">6.3 Functions in more detail</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/07/functions_as_values" class="level_1">6.4 Functions as values</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/07/conditional_statements" class="level_1">6.5 Conditional statements</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/07/pandas_indexing" class="level_1">6.6 Indexing in Pandas</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/07/noble_politics" class="level_1">6.7 Example: noble politics</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/07/safe_pandas" class="level_1">6.8 Safe Pandas</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/07/text_encoding" class="level_1">6.9 Text encoding</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/07/numbers_and_strings" class="level_1">6.10 Numbers and strings</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          
          

          <a href="/cfd2019/chapters/08/mean"><span class="nav__sub-title">7. The mean and straight line relationships</span></a>
        

        
        <ul>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/08/mean_meaning" class="level_1">7.1 The mean as a predictor</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/08/where_and_argmin" class="level_1">7.2 Where and argmin</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/08/mean_and_slopes" class="level_1">7.3 Mean and slopes</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/08/optimization" class="level_1">7.4 Optimization</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/08/finding_lines" class="level_1">7.5 Finding lines</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/08/using_minimize" class="level_1">7.6 Using minimize</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/08/inference_on_slopes" class="level_1">7.7 Believable slopes</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/08/combining_boolean_arrays" class="level_1">7.8 Combining Booleans</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/08/standard_scores" class="level_1">7.9 Standard scores</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/08/Correlation" class="level_1">7.10 Correlation</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          
          

          <a href="/cfd2019/chapters/09/classification"><span class="nav__sub-title">8. Classification</span></a>
        

        
        <ul>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/09/Nearest_Neighbors" class="level_1">8.2 Nearest neighbors</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/09/Training_and_Testing" class="level_1">8.3 Training and testing</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/09/Rows_of_Tables" class="level_1">8.4 Rows of tables</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/09/Implementing_the_Classifier" class="level_1">8.5 Implementing the classifier</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/09/Accuracy_of_the_Classifier" class="level_1">8.6 Accuracy of the classifier</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          
          

          <a href="/cfd2019/chapters/10/confidence"><span class="nav__sub-title">9. Confidence</span></a>
        

        
        <ul>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/10/havana_math" class="level_1">9.1 The education minister</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/10/random_choice" class="level_1">9.2 Random choice</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/10/first_bayes" class="level_1">9.2 Reverse probability</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/10/bayes_confidence" class="level_1">9.3 Back to Havana</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          
          

          <a href="/cfd2019/chapters/end/end_of_beginning"><span class="nav__sub-title">10. The end of the beginning</span></a>
        

        
      </li>
    
      <li>
        
          
          

          <a href="/cfd2019/chapters/exercises/exercises"><span class="nav__sub-title">Exercises</span></a>
        

        
        <ul>
          
        </ul>
        
      </li>
    
      <li>
        
          
          

          <a href="/cfd2019/chapters/extra/extra"><span class="nav__sub-title">Extra pages</span></a>
        

        
        <ul>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/extra/more_on_lists" class="level_1">More on lists</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/extra/monty_hall_lists" class="level_1">Monty Hall with lists</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/extra/data8_functions" class="level_1">Berkeley introduction to functions</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/extra/mean_deviations" class="level_1">Deviations around the mean</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/extra/mean_sq_deviations" class="level_1">Squared deviations around the mean</a></li>
          
            
            

            
            

            

            <li><a href="/cfd2019/chapters/extra/slope_deviations" class="level_1">Finding the best slope</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>

    

  
  </div>


    <article class="page textbook" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="headline" content="6.8 Safe Pandas">
      <meta itemprop="description" content="A lot of Pandas’ design is for speed and efficiency.">
      <meta itemprop="datePublished" content="April 07, 2020">
      

      <div class="page__inner-wrap">
        
          <header>
            <h1 id="page-title" class="page__title" itemprop="headline">6.8 Safe Pandas
</h1>
          </header>
        

        <section class="page__content" itemprop="text">
          
            

<!-- TOC will only show up if it has at least one item -->


  <aside class="sidebar__right">
    <nav class="toc">
      <header><h4 class="nav__title"><i class="fas fa-list-ul"></i>   On this page</h4></header>
      <ul class="toc__menu">
  <li><a href="#copies-and-views">Copies and views</a></li>
  <li><a href="#rule-1-copy-right">Rule 1: copy right.</a></li>
  <li><a href="#copies-views-confusing-warnings">Copies, views, confusing, warnings</a></li>
  <li><a href="#rule-2-make-errors-for-copyview-warnings">Rule 2: make errors for copy/view warnings</a></li>
  <li><a href="#copy-views-on-the-left">Copy, views, on the left</a></li>
  <li><a href="#rule-3-loc-left">Rule 3: loc left</a></li>
  <li><a href="#keep-calm-follow-the-three-rules">Keep calm, follow the three rules</a></li>
</ul>
    </nav>
  </aside>


          
          <!-- INTERACT LINKS -->

    
    
    <a class="notebook-link" href="https://matthew-brett.github.io/cfd2019/ipynb/07/safe_pandas.ipynb">Download notebook</a>
    <a class="interact-button" href="https://mybinder.org/v2/gh/matthew-brett/cfd2019/master?filepath=ipynb%2F07%2Fsafe_pandas.ipynb">Interact</a>


          <p>A lot of Pandas’ design is for speed and efficiency.</p>

<p>Unfortunately, this sometimes means that is it easy to use Pandas incorrectly, and so get results that you do not expect.</p>

<p>This page has some rules we suggest you follow to stay out of trouble when using Pandas.</p>

<p>As your understanding increases, you may find that you can relax some of these
rules, but the problems in this page can trip up experts, so please, be very
careful, and only relax these rules when you are very confident you understand
the underlying problems.  See <a href="/cfd2019/chapters/07/gory_pandas">Gory Pandas</a> for a short walk through some of the complexities.</p>

<h2 id="copies-and-views">Copies and views</h2>

<p>Consider this data frame, which should be familiar. It is a table where the
rows are course subjects and the columns include average ratings for all
University professors / lecturers teaching that subject. See <a href="/cfd2019/data/rate_my_professors">the dataset
page</a> for more detail.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
</code></pre></div></div>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'rate_my_course.csv'</span><span class="p">)</span>
<span class="n">ratings</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Discipline</th>
      <th>Number of Professors</th>
      <th>Clarity</th>
      <th>Helpfulness</th>
      <th>Overall Quality</th>
      <th>Easiness</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>English</td>
      <td>23343</td>
      <td>3.756147</td>
      <td>3.821866</td>
      <td>3.791364</td>
      <td>3.162754</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Mathematics</td>
      <td>22394</td>
      <td>3.487379</td>
      <td>3.641526</td>
      <td>3.566867</td>
      <td>3.063322</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Biology</td>
      <td>11774</td>
      <td>3.608331</td>
      <td>3.701530</td>
      <td>3.657641</td>
      <td>2.710459</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Psychology</td>
      <td>11179</td>
      <td>3.909520</td>
      <td>3.887536</td>
      <td>3.900949</td>
      <td>3.316210</td>
    </tr>
    <tr>
      <th>4</th>
      <td>History</td>
      <td>11145</td>
      <td>3.788818</td>
      <td>3.753642</td>
      <td>3.773746</td>
      <td>3.053803</td>
    </tr>
  </tbody>
</table>
</div>
</div>

<p>Now imagine that we have discovered that the rating for ‘Clarity’ in the first row is incorrect; it should be 4.0.</p>

<p>We get ready to make a new, fixed copy of the data frame, to store the modified
values.  We put the ‘Disciplines’ column into the data frame to start with.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fixed_ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">fixed_ratings</span><span class="p">[</span><span class="s">'Discipline'</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s">'Discipline'</span><span class="p">]</span>
</code></pre></div></div>

<p>Our next obvious step is to get the ‘Clarity’ column as a Pandas Series, for us
to work on.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">clarity</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s">'Clarity'</span><span class="p">]</span>
<span class="n">clarity</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div class="output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0    3.756147
1    3.487379
2    3.608331
3    3.909520
4    3.788818
Name: Clarity, dtype: float64
</code></pre></div></div>

<p>We set the corrected first value:</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">clarity</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">clarity</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div class="output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/Users/mb312/Library/Python/3.7/lib/python/site-packages/pandas/core/indexing.py:189: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
  self._setitem_with_indexer(indexer, value)

</code></pre></div></div>

<div class="output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0    4.000000
1    3.487379
2    3.608331
3    3.909520
4    3.788818
Name: Clarity, dtype: float64
</code></pre></div></div>

<p>Notice the warning.  We will come back to that soon.</p>

<p>Notice too that we have changed the value in the <code class="highlighter-rouge">clarity</code> Series.</p>

<p>Consider — <strong>what happens to the matching value in the original data frame</strong>?</p>

<p>To answer that question, we need to know what kind of thing our <code class="highlighter-rouge">clarity</code> Series was.</p>

<p><code class="highlighter-rouge">clarity</code> could be a <em>view</em> onto the ‘Clarity’ column in the original data
frame <code class="highlighter-rouge">ratings</code>.  A view is something that points to the <em>same memory</em>.  When
we have a view, the view is another way of looking at the <em>same data</em>.  If we
modify the data in the view, that means we also modify the original data frame,
because the <em>data is the same</em>.</p>

<p><code class="highlighter-rouge">clarity</code> could also be <em>copy</em> of the ‘Clarity’ column. A copy duplicates the
values from the original data.  Therefore a copy has its own values, and its
own memory.  Changing the data in the copy will have no effect on the original
data frame, because the <em>data is different</em>.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ratings</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Discipline</th>
      <th>Number of Professors</th>
      <th>Clarity</th>
      <th>Helpfulness</th>
      <th>Overall Quality</th>
      <th>Easiness</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>English</td>
      <td>23343</td>
      <td>4.000000</td>
      <td>3.821866</td>
      <td>3.791364</td>
      <td>3.162754</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Mathematics</td>
      <td>22394</td>
      <td>3.487379</td>
      <td>3.641526</td>
      <td>3.566867</td>
      <td>3.063322</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Biology</td>
      <td>11774</td>
      <td>3.608331</td>
      <td>3.701530</td>
      <td>3.657641</td>
      <td>2.710459</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Psychology</td>
      <td>11179</td>
      <td>3.909520</td>
      <td>3.887536</td>
      <td>3.900949</td>
      <td>3.316210</td>
    </tr>
    <tr>
      <th>4</th>
      <td>History</td>
      <td>11145</td>
      <td>3.788818</td>
      <td>3.753642</td>
      <td>3.773746</td>
      <td>3.053803</td>
    </tr>
  </tbody>
</table>
</div>
</div>

<p>We have found that the <code class="highlighter-rouge">clarity</code> Series was a <em>view</em>, because the change we made to <code class="highlighter-rouge">clarity</code> also changed the value in the original data frame.</p>

<p>This may not be what you expected, and it is probably not what you meant to do.</p>

<p>This leads to the first rule for safe handling of Pandas.</p>

<h2 id="rule-1-copy-right">Rule 1: copy right.</h2>

<p>We strongly suggest that when you get stuff out of a Pandas data frame or
Series by indexing, you always make what you have into a copy.</p>

<p>We call this rule <em>copy right</em>.</p>

<p>As a reminder <em>indexing</em> is where we fetch data from something using square
brackets.  Indexing can be: <em>direct</em>, with the square brackets directly
following the data frame or Series; or <em>indirect</em>, where the square brackets
follow the <code class="highlighter-rouge">.loc</code> or <code class="highlighter-rouge">.iloc</code> attributes of the data frame or Series.</p>

<p>For example, we have just used direct indexing (square brackets) to fetch the
‘Clarity’ data out of the <code class="highlighter-rouge">ratings</code> data frame.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Indexing to fetch a Series from a data frame.
</span><span class="n">clarity</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s">'Clarity'</span><span class="p">]</span>
</code></pre></div></div>

<p>We found that <code class="highlighter-rouge">clarity</code> is a <em>view</em> onto the ‘Clarity’ data in <code class="highlighter-rouge">ratings</code>.   This is rarely what we want.</p>

<p>Here we apply the <em>copy right</em> rule:</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Applying the "copy right" rule.
</span><span class="n">clearer_clarity</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s">'Clarity'</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</code></pre></div></div>

<p>Notice we apply the <code class="highlighter-rouge">.copy()</code> method to the ‘Clarity’ Series, so forcing Pandas to make us a copy of the data.</p>

<p>Now we have done that, we can modify the result without affecting the original data frame.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Modify the copy with some crazy value.
</span><span class="n">clearer_clarity</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">99</span>
<span class="n">clearer_clarity</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div class="output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0    99.000000
1     3.487379
2     3.608331
3     3.909520
4     3.788818
Name: Clarity, dtype: float64
</code></pre></div></div>

<p>This does not affect the original data frame:</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ratings</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Discipline</th>
      <th>Number of Professors</th>
      <th>Clarity</th>
      <th>Helpfulness</th>
      <th>Overall Quality</th>
      <th>Easiness</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>English</td>
      <td>23343</td>
      <td>4.000000</td>
      <td>3.821866</td>
      <td>3.791364</td>
      <td>3.162754</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Mathematics</td>
      <td>22394</td>
      <td>3.487379</td>
      <td>3.641526</td>
      <td>3.566867</td>
      <td>3.063322</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Biology</td>
      <td>11774</td>
      <td>3.608331</td>
      <td>3.701530</td>
      <td>3.657641</td>
      <td>2.710459</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Psychology</td>
      <td>11179</td>
      <td>3.909520</td>
      <td>3.887536</td>
      <td>3.900949</td>
      <td>3.316210</td>
    </tr>
    <tr>
      <th>4</th>
      <td>History</td>
      <td>11145</td>
      <td>3.788818</td>
      <td>3.753642</td>
      <td>3.773746</td>
      <td>3.053803</td>
    </tr>
  </tbody>
</table>
</div>
</div>

<h2 id="copies-views-confusing-warnings">Copies, views, confusing, warnings</h2>

<p>It can be very difficult to predict when Pandas indexing will give a copy or a view.</p>

<p>For example, here we use indirect indexing (square brackets following <code class="highlighter-rouge">.iloc</code>) to select the row of <code class="highlighter-rouge">ratings</code> with index label 0.  Remember <code class="highlighter-rouge">.loc</code> indexing uses the index labels, not positions, although in this case the index has label 0 for position 0.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">row_0</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">row_0</span>
</code></pre></div></div>

<div class="output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Discipline              English
Number of Professors      23343
Clarity                       4
Helpfulness             3.82187
Overall Quality         3.79136
Easiness                3.16275
Name: 0, dtype: object
</code></pre></div></div>

<p>We saw earlier that direct indexing to select a column ‘Clarity’ gave us
a view, meaning that we could change the values in the data frame by changing
the Series <code class="highlighter-rouge">clarity</code> we got from indexing.  In fact this is also true if we use indirect indexing with <code class="highlighter-rouge">.loc</code> or <code class="highlighter-rouge">.iloc</code>.  Check this by trying <code class="highlighter-rouge">clarity = ratings.loc[:, 'Clarity']</code> in the code above.</p>

<p>We have just fetched the row labeled 0 using <code class="highlighter-rouge">.loc</code>.  Given what we know about
fetching a column, it would be reasonable to predict this would give us a view.</p>

<p>Does it give a view?  Or a copy?</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Changing the 'Clarity' value of the first row.
</span><span class="n">row_0</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">'Clarity'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">row_0</span>
</code></pre></div></div>

<div class="output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/Users/mb312/Library/Python/3.7/lib/python/site-packages/ipykernel_launcher.py:2: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
  

</code></pre></div></div>

<div class="output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Discipline              English
Number of Professors      23343
Clarity                       5
Helpfulness             3.82187
Overall Quality         3.79136
Easiness                3.16275
Name: 0, dtype: object
</code></pre></div></div>

<p>We will get to the warning soon.</p>

<p>Did we change the original data frame?</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ratings</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Discipline</th>
      <th>Number of Professors</th>
      <th>Clarity</th>
      <th>Helpfulness</th>
      <th>Overall Quality</th>
      <th>Easiness</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>English</td>
      <td>23343</td>
      <td>4.000000</td>
      <td>3.821866</td>
      <td>3.791364</td>
      <td>3.162754</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Mathematics</td>
      <td>22394</td>
      <td>3.487379</td>
      <td>3.641526</td>
      <td>3.566867</td>
      <td>3.063322</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Biology</td>
      <td>11774</td>
      <td>3.608331</td>
      <td>3.701530</td>
      <td>3.657641</td>
      <td>2.710459</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Psychology</td>
      <td>11179</td>
      <td>3.909520</td>
      <td>3.887536</td>
      <td>3.900949</td>
      <td>3.316210</td>
    </tr>
    <tr>
      <th>4</th>
      <td>History</td>
      <td>11145</td>
      <td>3.788818</td>
      <td>3.753642</td>
      <td>3.773746</td>
      <td>3.053803</td>
    </tr>
  </tbody>
</table>
</div>
</div>

<p>No, we didn’t change the original data frame — and we conclude that
<code class="highlighter-rouge">row_0</code> is a <em>copy</em>.</p>

<p>Our first, correct, response is to follow the <em>copy right</em> rule, and make this copy explicit, so we know exactly what we have:</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># The "copy right" rule again.
</span><span class="n">copied_row_0</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</code></pre></div></div>

<p>We no longer have a nasty warning when we modify <code class="highlighter-rouge">copied_row_0</code>, because
Pandas knows we made a copy, so it does not need to warn us that we may be
making a mistake:</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># We don't get a warning when we change the copied result.
</span><span class="n">copied_row_0</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">'Clarity'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">copied_row_0</span>
</code></pre></div></div>

<div class="output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Discipline              English
Number of Professors      23343
Clarity                       5
Helpfulness             3.82187
Overall Quality         3.79136
Easiness                3.16275
Name: 0, dtype: object
</code></pre></div></div>

<p>Please worry about these warnings.  In fact, in the interests of safety, we come to rule 2.</p>

<h2 id="rule-2-make-errors-for-copyview-warnings">Rule 2: make errors for copy/view warnings</h2>

<p>Pandas has a setting that allows you to change the nasty warning about setting with copies into an error.</p>

<p>We strongly suggest that you do that, for all your notebooks, like this:</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s">'mode.chained_assignment'</span><span class="p">,</span><span class="s">'raise'</span><span class="p">)</span>
</code></pre></div></div>

<p>After you have done this, Pandas will stop if you try to do something like this:</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">row_0</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="c1"># Copy?  Or wiew?  Difficult to guess.
# Now this generates an error.
</span><span class="n">row_0</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">'Clarity'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">99</span>
</code></pre></div></div>

<div class="output_traceback_line highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SettingWithCopyError                      Traceback (most recent call last)
   ...
SettingWithCopyError: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
</code></pre></div></div>

<p>At first you will find this advice annoying.  Your code will generate confusing
errors, and you will be tempted to remove this error option to make the errors
go away.  Please be patient.  You will find that, if you follow the <em>copy right</em> rule carefully, most of these errors go away.</p>

<h2 id="copy-views-on-the-left">Copy, views, on the left</h2>

<p>Now consider this code:</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ratings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">'Clarity'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">99</span>
</code></pre></div></div>

<div class="output_traceback_line highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SettingWithCopyError                      Traceback (most recent call last)
   ...
SettingWithCopyError: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
</code></pre></div></div>

<p>Because we have set the <code class="highlighter-rouge">mode.chained_assignment</code> option to <code class="highlighter-rouge">error</code> above, this generates an error — but why?</p>

<p>The reason is the same as the reason for the previous error.  The code in the
cell directly above is just a short-cut for this exact equivalent.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">row_0</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">row_0</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">'Clarity'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">99</span>
</code></pre></div></div>

<div class="output_traceback_line highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SettingWithCopyError                      Traceback (most recent call last)
   ...
SettingWithCopyError: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
</code></pre></div></div>

<p>Specifically, when Python sees <code class="highlighter-rouge">ratings.loc[0].loc['Clarity'] = 99</code>, it first
evaluates <code class="highlighter-rouge">ratings.loc[0]</code> to generate a temporary copy.  Let’s call this
temporary copy <code class="highlighter-rouge">tmp</code>. It then tries to set the value into the copy with
<code class="highlighter-rouge">tmp.loc['Clarity'] = 99</code>.  This generates the same error as you saw before.</p>

<p>As you have probably guessed from the option name above, Pandas calls this
<em>chained assignment</em>, because you are: first, fetching the stuff you want do
the assignment on (<code class="highlighter-rouge">ratings.loc[0]</code>) and then doing the assignment
<code class="highlighter-rouge">.loc['Clarity'] = 99</code>. There are two steps on the left hand side, in a chain,
first fetching the data, then assigning.</p>

<p>The problem that Pandas has is that it cannot tell that this has happened, so
it can’t tell what you mean.  Python will ask Pandas to generate
<code class="highlighter-rouge">ratings.loc[0]</code> first, which it does, to generate the temporary copy that we
can call <code class="highlighter-rouge">tmp</code>. Python then ask Pandas to set the value with
<code class="highlighter-rouge">tmp.loc['Clarity'] = 99</code>.  When Pandas gets this second instruction, it has no
way of knowing that <code class="highlighter-rouge">tmp</code> came from the combined instruction
<code class="highlighter-rouge">ratings.loc[0].loc['Clarity'] = 99</code>, and so all it can do is set the value
into the copy, as instructed.</p>

<p>This leads us to the last rule.</p>

<h2 id="rule-3-loc-left">Rule 3: loc left</h2>

<p>When you do want to use indexing on the left hand side, to set some values into
a data frame or Series, try do to this all in one shot, using indirect indexing
with <code class="highlighter-rouge">.loc</code> or <code class="highlighter-rouge">iloc</code>.</p>

<p>For example, you have just see that this generates an error, and why:</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ratings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s">'Clarity'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">99</span>
</code></pre></div></div>

<div class="output_traceback_line highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SettingWithCopyError                      Traceback (most recent call last)
   ...
SettingWithCopyError: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
</code></pre></div></div>

<p>You can avoid that error by doing all your left-hand-side indexing in one shot, like this:</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ratings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s">'Clarity'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">99</span>
</code></pre></div></div>

<p>Notice there is no error.  This is because, in this second case, Pandas gets
all the instructions in one go.  It can see from this combined instruction that
we <em>meant</em> to set the ‘Clarity’ value for the row labeled 0 in the <code class="highlighter-rouge">ratings</code>
data frame, and does just this.</p>

<h2 id="keep-calm-follow-the-three-rules">Keep calm, follow the three rules</h2>

<p>Do not worry if some of this is not immediately clear; it is not easy.</p>

<p>The trick is to remember the three rules:</p>

<ul>
  <li>Copy right.</li>
  <li>Make copy warnings into errors.</li>
  <li>Use <code class="highlighter-rouge">.loc</code> and <code class="highlighter-rouge">.iloc</code> for your left-hand-side indexing.</li>
</ul>

          
        </section>

        <footer class="page__meta">
          
          


        </footer>

        

        
  <nav class="pagination">
    
      <a href="/cfd2019/chapters/07/pandas_indexing_reprise" class="pagination--pager" title="Pandas indexing reprise
">Previous</a>
    
    
      <a href="/cfd2019/chapters/07/text_encoding" class="pagination--pager" title="6.9 Text encoding
">Next</a>
    
  </nav>


      </div>

      
    </article>
  </div>
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><input type="text" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
    <div id="results" class="results"></div></div>
      </div>
    

    

    
  <script src="/cfd2019/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.12/js/all.js"></script>




<script src="/cfd2019/assets/js/lunr/lunr.min.js"></script>
<script src="/cfd2019/assets/js/lunr/lunr-store.js"></script>
<script src="/cfd2019/assets/js/lunr/lunr-en.js"></script>




    <!-- Custom scripts to load after site JS is loaded -->

    <!-- Custom HTML used for the textbooks -->
<!-- Configure, then load MathJax -->
<script type="text/javascript">
  window.MathJax = {
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true,
      processEnvironments: true
    }
  };
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML-full,Safe" type="text/javascript"></script>


<script type="text/javascript">
// --- To auto-embed hub URLs in interact links if given in a RESTful fashion ---
function getJsonFromUrl(url) {
  var query = url.split('?');
  if (query.length < 2) {
    // No queries so just return false
    return false;
  }
  query = query[1];
  // Collect REST params into a dictionary
  var result = {};
  query.split("&").forEach(function(part) {
    var item = part.split("=");
    result[item[0]] = decodeURIComponent(item[1]);
  });
  return result;
}

// Parse a Binder URL, converting it to the string needed for JupyterHub
function binder2Jupyterhub(url) {
  newUrl = {};
  parts = url.split('v2/gh/')[1];
  // Grab the base repo information
  repoinfo = parts.split('?')[0];
  var [org, repo, ref] = repoinfo.split('/');
  newUrl['repo'] = ['https://github.com', org, repo].join('/');
  newUrl['branch'] = ref
  // Grab extra parameters passed
  params = getJsonFromUrl(url);
  if (params['filepath'] !== undefined) {
    newUrl['subPath'] = params['filepath']
  }
  return jQuery.param(newUrl);
}

// Filter out potentially unsafe characters to prevent xss
function safeUrl(url)
{
   return String(encodeURIComponent(url))
            .replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
}

function addParamToInternalLinks(hub) {
  var links = $("a").each(function() {
    var href = this.href;
    // If the link is an internal link...
    if (href.search("https://matthew-brett.github.io") !== -1 || href.startsWith('/') || href.search("127.0.0.1:") !== -1) {
      // Assume we're an internal link, add the hub param to it
      var params = getJsonFromUrl(href);
      if (params !== false) {
        // We have REST params, so append a new one
        params['hub'] = hub;
      } else {
        // Create the REST params
        params = {'hub': hub};
      }
      // Update the link
      var newHref = href.split('?')[0] + '?' + jQuery.param(params);
      this.setAttribute('href', decodeURIComponent(newHref));
    }
  });
  return false;
}

  // Update interact links
function updateInteractLink() {
    // hack to make this work since it expects a ? in the URL
    rest = getJsonFromUrl("?" + location.search.substr(1));
    hubUrl = rest['hub'];
    if (hubUrl !== undefined) {
      // Sanitize the hubUrl
      hubUrl = safeUrl(hubUrl);
      // Add HTTP text if omitted
      if (hubUrl.indexOf('http') < 0) {hubUrl = 'http://' + hubUrl;}
      link = $("a.interact-button")[0];
      if (link !== undefined) {
          // Update the interact link URL
          var href = link.getAttribute('href');
          if ('binder' == 'binder') {
            // If binder links exist, we need to re-work them for jupyterhub
            first = [hubUrl, 'hub', 'user-redirect', 'git-sync'].join('/')
            href = first + '?' + binder2Jupyterhub(href);
          } else {
            // If JupyterHub links, we only need to replace the hub url
            href = href.replace("https://mybinder.org", hubUrl);
          }
          link.setAttribute('href', decodeURIComponent(href));

          // Add text after interact link saying where we're launching
          hubUrlNoHttp = decodeURIComponent(hubUrl).replace('http://', '').replace('https://', '');
          $("a.interact-button").after($('<div class="interact-context">on ' + hubUrlNoHttp + '</div>'));

      }
      // Update internal links so we retain the hub url
      addParamToInternalLinks(hubUrl);
    }
}

// --- Highlight the part of sidebar for current page ---

// helper to replace trailing slash
function replaceSlash(string)
{
    return string.replace(/\/$/, "");
}

// Add a class to the current page in the sidebar
function highlightSidebarCurrentPage()
{
  var currentpage = location.href;
  var links = $('.sidebar .nav__items a');
  var ii = 0;
  for(ii; ii < links.length; ii++) {
    var link = links[ii];
    if(replaceSlash(link.href) == replaceSlash(currentpage)) {
      // Add CSS for styling
      link.classList.add("current");
      // Scroll to this element
      $('div.sidebar').scrollTop(link.offsetTop - 300);
    }
  }
}

// --- Set up copy/paste for code blocks ---
function addCopyButtonToCode(){
  // get all <code> elements
  var allCodeBlocksElements = $( "div.input_area code, div.highlighter-rouge code" );

  allCodeBlocksElements.each(function(ii) {
   	// add different id for each code block

  	// target
    var currentId = "codeblock" + (ii + 1);
    $(this).attr('id', currentId);

    //trigger
    var clipButton = '<button class="btn copybtn" data-clipboard-target="#' + currentId + '"><img src="https://clipboardjs.com/assets/images/clippy.svg" width="13" alt="Copy to clipboard"></button>';
       $(this).after(clipButton);
    });

    new Clipboard('.btn');
}

// Run scripts when page is loaded
$(document).ready(function () {
  // Add anchors to H1 etc links
  anchors.add();
  // Highlight current page in sidebar
  highlightSidebarCurrentPage();
  // Add copy button to code blocks
  addCopyButtonToCode();
  // Update the Interact link if a REST param given
  updateInteractLink();
});
</script>

  </body>
</html>
